<!DOCTYPE html>
<html>
<head>
	<title>BOARD</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./style.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
</head>
<body style="padding: 1vh;">
	<h2>掲示板</h2>
	<div id="" style="color: green; margin: 1vh"></div>

	<label>Name :</label><br>
	<input id="name" type="text" required><br>
	<label>Message :</label><br>
	<textarea id="message" rows="4" cols="40" placeholder="ここにメッセージを入力してください。" autocomplete="off" required></textarea><br>
	<button id="send" type="button">投稿</button>
	<hr>
	<table id="board" class="type01">
		<thead><tr><th>Time</th><th>Name</th><th>Message</th></tr></thead>
		<tbody></tbody>
	</table>

	<script type="text/javascript">
		$(function() {
			$("#send").click(function(){
				var name = $("#name").val();
				var message = $("#message").val();
				$.ajax({
					type: "POST",
					url: "step1_insert.php",
					data: {
						"name": name,
						"message": message
					},
					success: function(data){
						console.log('send post!');
						$("message").remove();
					}
				});
			});
		});
	</script>

	<script type="text/javascript">
		// リアルタイム更新 ポーリング
		$(function() {
			var POLLLING_INVERVAL_TIME_IN_MILLIS = 1000;//1s
			(function polling() {
				if(!document.hidden) { // このページが表示されているときだけリクエストする
						getCountUp();
				}
				window.setTimeout(polling, POLLLING_INVERVAL_TIME_IN_MILLIS);
			}());
			// PHP API からのデータ受信
			function getCountUp() {
				$.ajax({
					type : "GET",
					url : "step1_fetch.php",
					content : "application/json",
					dataType : "json",
				}).done(function(j_data) {
					console.log(j_data);
					// 初期宣言
					var inner_data = "";
					// テーブルhtmlを作成
					for (var i = j_data.length - 1; i >= 0; i--) {
						inner_data += "<tr><td>"+j_data[i]["date"]+"</td><td>"+j_data[i]["name"]+"</td><td>"+j_data[i]["message"]+"</td></tr>"
					}
					// テーブルhtmlが同じではないとき
					if ( inner_data != $("table#board tbody").html() ) {
						$("table#board tbody *").remove(); //全削除
						$("table#board tbody").append(inner_data); //追加
					}
				}).fail(function(jqXHR, textStatus) {
					console.log(jqXHR);
					$("board").val("error");
				});
			}
		});
	</script>

</body>
</html>